# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Desarrollo y Comandos

### Scripts de Construcción y Ejecución
- **Desarrollo**: `./scripts/run_dev.sh` o `flutter run --flavor dev -t lib/main_dev.dart`
- **Producción**: `./scripts/run_prod.sh` o `flutter run --flavor prod -t lib/main.dart`
- **Build Web Dev**: `./scripts/build_web.sh dev`
- **Build Web Prod**: `./scripts/build_web.sh prod`
- **Build APK Dev**: `./scripts/build_dev.sh`
- **Build APK Prod**: `./scripts/build_prod.sh`

### Credenciales de Desarrollo
- Email de prueba: `algonclagu@gmail.com`
- Contraseña: `123456`

### Generación de Código
- **Build Runner**: `flutter pub run build_runner build --delete-conflicting-outputs`
  - Ejecutar después de cambios en injectable, freezed, o json_serializable
  - Genera archivos: `*.g.dart`, `*.freezed.dart`, `locator.config.dart`
- **GetIt Injectable**: Regenerar `lib/core/di/locator.config.dart` después de cambios en `@injectable`, `@singleton`, etc.

### Testing y Linting
- **Flutter Analyze**: `flutter analyze`
- **Tests**: `flutter test`
- **Tests de integración**: `flutter test integration_test`
- **Lint**: Configurado con `flutter_lints` y reglas estrictas en `analysis_options.yaml`
  - Incluye strict-casts, strict-inference, strict-raw-types
  - Línea máxima: 120 caracteres

## Arquitectura del Proyecto

### Clean Architecture con BLoC
Estructura de 3 capas implementada:
- **Domain**: Entidades y repositorios abstractos (`lib/features/*/domain/`)
- **Data**: Implementaciones de repositorios y datasources (`lib/features/*/data/`)
- **Presentation**: UI, BLoC, páginas (`lib/features/*/presentation/`)

### Inyección de Dependencias (GetIt + Injectable)
- **Configuración**: `lib/core/di/locator.dart` y `lib/core/di/locator.config.dart` (generado)
- **Inicialización**: `initializeDependencies()` llamado en `main.dart` y `main_dev.dart` antes de `runApp()`
- **Acceso global**: `getIt<T>()` desde cualquier lugar
- **Annotations disponibles**: `@injectable`, `@singleton`, `@lazySingleton`, `@preResolve`
- Ejecutar `flutter pub run build_runner build --delete-conflicting-outputs` después de añadir nuevas dependencias

### Navegación (GoRouter)
- **Configuración central**: `lib/core/router/app_router.dart` con ~80+ rutas definidas
- **AuthGuard**: Protege rutas automáticamente mediante `redirect` y `refreshListenable`
- **ShellRoute**: Mantiene `MainLayout` persistente mientras cambia el contenido
- **Ruta de login**: `/login` (sin layout, acceso público)
- **Rutas protegidas**: Todo bajo `ShellRoute` requiere autenticación
- **Stream de autenticación**: `authStateChanges` reactivo desde `AuthRepository`
- **Nombres de ruta**: Usar `name` parámetro para navegación tipada (ej: `context.goNamed('home')`)

### Sistema de Flavors
- **Dev**: `lib/main_dev.dart` → `F.appFlavor = Flavor.dev`
  - Firebase options específicos de desarrollo
  - Banner de debug visible
  - Package ID: `com.ambutrack.web.dev`
- **Prod**: `lib/main.dart` → `F.appFlavor = Flavor.prod`
  - Firebase options de producción
  - Sin banner de debug
  - Package ID: `com.ambutrack.web`
- **Firebase**: Configuraciones en `lib/core/firebase/firebase_options.dart`
- **Inicialización**: Firebase se inicializa antes de `initializeDependencies()`

### DataSource Personalizado
- **Repositorio específico**: `ambutrack_core_datasource` desde GitHub (ref: main)
- **Propósito**: Capa de abstracción para acceso a Firebase Firestore
- **Tipos disponibles**: Simple (datos estáticos), Complex (dinámicos), Real-Time (listeners)
- **Ubicación de modelos/entidades**: Se crean en el paquete core, NO en el proyecto principal
  - Ejemplo: `ambutrack_core_datasource/lib/features/[feature]/models/`
  - Ejemplo: `ambutrack_core_datasource/lib/features/[feature]/entities/`
- **Reutilización**: Modelos compartidos entre proyectos web/mobile

### Gestión de Estado
- **BLoC Pattern** con `flutter_bloc` (v9.1.1)
- **Estructura por feature**: Cada feature tiene su propio BLoC
- **Equatable**: Para comparaciones eficientes de estados/eventos
- **AuthBloc global**: Inyectado en el widget raíz `App` mediante `BlocProvider`
- **Eventos y Estados**: Tipados y definidos por feature
- **Patrón típico**: `[Feature]Event`, `[Feature]State`, `[Feature]Bloc`

## Dependencias Críticas

### Paquetes Personalizados (Git)
- **ambutrack_core_datasource**: Abstracción de Firebase/Firestore
  - GitHub: `jesusperezdeveloper/ambutrack_core_datasource`
- **iautomat_design_system**: Sistema de diseño empresarial
  - GitHub: `jesusperezdeveloper/iautomat_design_system`
  - Proporciona componentes UI reutilizables
- **iautomat_auth_manager**: Gestión de autenticación
  - GitHub: `jesusperezdeveloper/iautomat_auth_manager`
  - Integrado con Firebase Auth

### Firebase Suite
- `firebase_core: ^4.1.1`
- `firebase_auth: ^6.0.2`
- `cloud_firestore: ^6.0.2`
- Configuración de flavors en `android/app/src/[dev|prod]/google-services.json`

### State Management & DI
- `flutter_bloc: ^9.1.1` y `bloc: ^9.0.1`
- `get_it: ^7.7.0` y `injectable: ^2.4.4`
- `equatable: ^2.0.5`

### Navegación
- `go_router: ^14.2.7`

### Generación de Código (dev_dependencies)
- `build_runner: ^2.4.13`
- `injectable_generator: ^2.6.2`
- `freezed: ^2.5.7` y `freezed_annotation: ^2.4.4`
- `json_serializable: ^6.8.0`

### Testing (dev_dependencies)
- `bloc_test: ^10.0.0`
- `mocktail: ^1.0.4`
- `integration_test` (SDK)

## Patrones Específicos

### Creación de Features
1. Crear estructura manual o con generadores externos (Mason)
2. Estructura requerida: `lib/features/[feature_name]/`
   - `domain/` → Entidades, repositorios abstractos
   - `data/` → Implementaciones de repositorios, datasources
   - `presentation/` → Pages, widgets, BLoC (events, states, bloc)
3. Registrar dependencias con annotations de Injectable
   - Repositories: `@LazySingleton(as: IRepository)`
   - BLoCs: `@injectable`
   - DataSources: `@singleton` o `@injectable`
4. Agregar rutas en `lib/core/router/app_router.dart`
5. Ejecutar `flutter pub run build_runner build --delete-conflicting-outputs`
6. Reiniciar la app si es necesario

### Configuración de DataSources
- **IMPORTANTE**: Modelos y entidades se crean en `ambutrack_core_datasource`, NO en este proyecto
- **Estructura en paquete core**:
  - `ambutrack_core_datasource/lib/features/[feature]/models/`
  - `ambutrack_core_datasource/lib/features/[feature]/entities/`
- **Tipos de DataSource**:
  - **Simple**: Datos estáticos (configuraciones, catálogos)
  - **Complex**: Datos dinámicos con lógica (usuarios, servicios)
  - **Real-Time**: Listeners de Firestore para actualizaciones en tiempo real
- Configurar cache según tipo de datos y frecuencia de actualización
- Los modelos del core son reutilizables entre proyectos web/mobile

### Autenticación y Seguridad
- **AuthRepository**: Define contrato de autenticación
- **AuthBloc**: Gestiona estado global de autenticación
  - `AuthCheckRequested`: Verifica estado al iniciar
  - `authStateChanges`: Stream reactivo de cambios de autenticación
- **AuthGuard**: Middleware en GoRouter
  - Redirige a `/login` si no autenticado
  - Redirige a `/` si ya autenticado e intenta acceder a login
- **Firebase Auth**: Backend de autenticación

### Tema y Diseño
- **AppColors**: Archivo centralizado en `lib/core/theme/app_colors.dart`
  - SIEMPRE usar AppColors para toda la aplicación
  - No usar Colors directamente (excepto white/black/transparent)
- **AppTheme**: Temas light/dark configurados
- **MainLayout**: Layout persistente con AppBar y menú lateral
- **SafeArea**: OBLIGATORIO en todas las páginas

### Manejo de Errores
- Usar `Either` pattern para operaciones que pueden fallar (dartz/fpdart)
- Estados de error tipados en BLoC states
- Captura de errores en repositories
- Mostrar errores en UI mediante BlocBuilder/BlocListener

### Internacionalización
- Archivos JSON: `lib/core/lang/es.json`, `lib/core/lang/en.json`
- Actualmente comentado `easy_localization` (conflicto con design system)
- Usar traducciones cuando se resuelva el conflicto